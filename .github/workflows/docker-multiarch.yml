name: AdGuard VPN CLI Builder

on:
    # Daily automatic builds
    schedule:
        - cron: "0 3 * * *"

    # Manual trigger with options
    workflow_dispatch:
        inputs:
            runner:
                description: "Choose runner type"
                type: choice
                default: "ubuntu-latest"
                options:
                    - "ubuntu-24.04"
                    - "ubuntu-22.04"
                    - "ubuntu-24.04-arm"
                    - "ubuntu-22.04-arm"
                    - "ubuntu-latest"

            version:
                description: "AdGuard VPN CLI version (e.g., v1.2.3, latest for newest)"
                required: false
                default: "latest"
                type: string

            verify_build:
                description: "Verify build functionality"
                required: false
                default: false
                type: boolean

            force_rebuild:
                description: "Force rebuild even if image exists"
                required: false
                default: false
                type: boolean

            clear_cache:
                description: "Clear build cache before building"
                required: false
                default: false
                type: boolean

# Optimized concurrency management
concurrency:
    group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}-${{ github.event.inputs.version || 'latest' }}
    cancel-in-progress: true

# Enhanced global environment variables
env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}
    DOCKERHUB_REPO: supersunho/adguardvpn-cli
    DOCKER_BUILDKIT: 1
    BUILDKIT_PROGRESS: plain
    CACHE_VERSION: v1

# Default permissions
permissions:
    contents: read

##############################################################################
# 1) Prepare version and matrix
##############################################################################
jobs:
    prepare:
        runs-on: ${{ github.event.inputs.runner || 'ubuntu-latest' }}
        outputs:
            version: ${{ steps.get-version.outputs.version }}
            version_clean: ${{ steps.get-version.outputs.version_clean }}
            version_base: ${{ steps.get-version.outputs.version_base }}
            matrix: ${{ steps.generate-matrix.outputs.matrix }}

        steps:
            - name: ğŸ” Fetch latest AdGuard VPN CLI version
              id: get-version
              run: |
                  if [ "${{ github.event.inputs.version }}" = "latest" ] || [ -z "${{ github.event.inputs.version }}" ]; then
                    echo "ğŸ” Fetching latest AdGuard VPN CLI release..."
                    RELEASE_DATA=$(curl -s https://api.github.com/repos/AdguardTeam/AdGuardVPNCLI/releases/latest)
                    VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name)
                  else
                    VERSION="${{ github.event.inputs.version }}"
                  fi

                  VERSION_CLEAN=${VERSION#v}
                  VERSION_BASE=${VERSION_CLEAN%%-*}

                  echo "ğŸ·ï¸ Target tag        : $VERSION"
                  echo "ğŸ”¢ Clean tag         : $VERSION_CLEAN"
                  echo "ğŸ”‘ Numeric-only tag  : $VERSION_BASE"

                  echo "version=$VERSION"        >> $GITHUB_OUTPUT
                  echo "version_clean=$VERSION_CLEAN"  >> $GITHUB_OUTPUT
                  echo "version_base=$VERSION_BASE"    >> $GITHUB_OUTPUT

            - name: ğŸ—ï¸ Generate build matrix
              id: generate-matrix
              run: |
                  echo "ğŸ“¦ Generating multi-architecture build matrix..."
                  MATRIX=$(cat << 'EOF'
                  {
                    "include": [
                      { "arch": "amd64", "platform": "linux/amd64" },
                      { "arch": "arm64", "platform": "linux/arm64" },
                      { "arch": "armv7", "platform": "linux/arm/v7" }
                    ]
                  }
                  EOF
                  )
                  echo "matrix=$(echo "$MATRIX" | jq -c .)" >> $GITHUB_OUTPUT
                  echo "âœ… Matrix generated with $(echo "$MATRIX" | jq '.include | length') architectures"

    ##############################################################################
    # 2) Build multi-arch images
    ##############################################################################
    build:
        needs: prepare
        runs-on: ${{ github.event.inputs.runner || 'ubuntu-latest' }}
        permissions:
            contents: read
            packages: write
        strategy:
            matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
            fail-fast: false
        steps:
            - name: ğŸ¯ Display build target information
              run: |
                  echo "ğŸ¯ Building AdGuard VPN CLI container for: ${{ matrix.platform }}"
                  echo "ğŸ·ï¸ Version: ${{ needs.prepare.outputs.version_clean }}"
                  echo "ğŸ—ï¸ Architecture: ${{ matrix.arch }}"
                  echo "ğŸ“¦ Platform: ${{ matrix.platform }}"

            - name: ğŸ” Check existing images via registry API
              id: check-images
              run: |
                  IMAGE_TAG="${{ needs.prepare.outputs.version_base }}-${{ matrix.arch }}"
                  echo "ğŸ” Checking if image exists: $IMAGE_TAG"

                  # Always build on workflow_dispatch with force_rebuild
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                    echo "ğŸ”„ Force rebuild enabled via workflow_dispatch"
                    echo "build_image=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # Check GHCR for existing image
                  TOKEN="${{ secrets.GITHUB_TOKEN }}"
                  REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

                  echo "ğŸ” Checking GHCR for existing image..."
                  GHCR_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" \
                    "https://api.github.com/user/packages/container/$REPO_NAME/versions" 2>/dev/null || echo '[]')

                  if echo "$GHCR_RESPONSE" | jq -e --arg TAG "$IMAGE_TAG" '.[] | select(.metadata.container.tags[]? == $TAG)' >/dev/null 2>&1; then
                    echo "âœ… Image $IMAGE_TAG already exists in GHCR"
                    if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
                      echo "ğŸ”„ Force rebuild enabled, proceeding anyway"
                      echo "build_image=true" >> $GITHUB_OUTPUT
                    else
                      echo "â­ï¸ Skipping build (image exists, use force_rebuild to override)"
                      echo "build_image=false" >> $GITHUB_OUTPUT
                    fi
                  else
                    echo "âŒ Image $IMAGE_TAG not found in GHCR, proceeding with build"
                    echo "build_image=true" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸ“¥ Checkout repository
              if: steps.check-images.outputs.build_image == 'true'
              uses: actions/checkout@v4

            - name: ğŸ› ï¸ Set up QEMU
              if: steps.check-images.outputs.build_image == 'true'
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: ${{ matrix.platform }}

            - name: ğŸ› ï¸ Set up Docker Buildx
              if: steps.check-images.outputs.build_image == 'true'
              uses: docker/setup-buildx-action@v3
              with:
                  driver: docker-container
                  use: true
                  install: true

            - name: ğŸ”‘ Login to GHCR
              if: steps.check-images.outputs.build_image == 'true'
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ”‘ Login to Docker Hub
              if: steps.check-images.outputs.build_image == 'true'
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: ğŸ“¦ Initialize cache directories
              if: steps.check-images.outputs.build_image == 'true'
              run: |
                  mkdir -p /tmp/apt-cache /tmp/apt-lib
                  echo "ğŸ“ Cache directories initialized"

            - name: ğŸ’¾ Cache build dependencies
              if: steps.check-images.outputs.build_image == 'true'
              uses: actions/cache@v4
              id: system-cache
              with:
                  path: |
                      /tmp/apt-cache
                      /tmp/apt-lib
                  key: ${{ env.CACHE_VERSION }}-adguard-cache-${{ runner.os }}-${{ runner.arch }}-${{ matrix.arch }}-${{ needs.prepare.outputs.version_base }}
                  restore-keys: |
                      ${{ env.CACHE_VERSION }}-adguard-cache-${{ runner.os }}-${{ runner.arch }}-${{ matrix.arch }}-

            - name: ğŸš€ Build and push (${{ matrix.platform }})
              if: steps.check-images.outputs.build_image == 'true'
              id: build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  platforms: ${{ matrix.platform }}
                  push: true
                  no-cache: ${{ github.event.inputs.clear_cache == 'true' }}
                  cache-from: |
                      type=gha,scope=${{ env.CACHE_VERSION }}-adguard-${{ matrix.arch }}-${{ needs.prepare.outputs.version_base }}
                  cache-to: |
                      type=gha,mode=max,scope=${{ env.CACHE_VERSION }}-adguard-${{ matrix.arch }}-${{ needs.prepare.outputs.version_base }}
                  build-args: |
                      AGCLI_VERSION=${{ needs.prepare.outputs.version_base }}
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version_base }}-${{ matrix.arch }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-${{ matrix.arch }}
                      ${{ env.DOCKERHUB_REPO }}:${{ needs.prepare.outputs.version_base }}-${{ matrix.arch }}
                      ${{ env.DOCKERHUB_REPO }}:latest-${{ matrix.arch }}
                  provenance: false

            - name: ğŸ§ª Comprehensive container verification
              if: steps.check-images.outputs.build_image == 'true' && github.event.inputs.verify_build == 'true'
              run: |
                  IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version_base }}-${{ matrix.arch }}"
                  echo "ğŸ” Starting verification suite for ${{ matrix.arch }}..."

                  echo "ğŸ“‹ Test 1: Binary Verification"
                  docker run --rm --platform ${{ matrix.platform }} --entrypoint "" "$IMAGE" which adguardvpn-cli \
                    && echo " - âœ… AdGuard VPN CLI binary exists" \
                    || echo " - âŒ Binary missing"

                  echo "ğŸ“‹ Test 2: Version Check"
                  docker run --rm --platform ${{ matrix.platform }} --entrypoint "" "$IMAGE" adguardvpn-cli --version \
                    && echo " - âœ… Version command working" \
                    || echo " - âŒ Version command failed"

                  echo "ğŸ“‹ Test 3: Help Command"
                  docker run --rm --platform ${{ matrix.platform }} --entrypoint "" "$IMAGE" adguardvpn-cli --help >/dev/null \
                    && echo " - âœ… Help command working" \
                    || echo " - âŒ Help command failed"

                  echo "ğŸ‰ Verification completed for ${{ matrix.arch }}!"

            - name: ğŸ“„ Export digest
              if: steps.check-images.outputs.build_image == 'true'
              run: |
                  mkdir -p /tmp/digests/${{ matrix.arch }}
                  echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.arch }}/digest.txt
                  echo "ğŸ“ Digest saved for ${{ matrix.arch }}"

            - name: ğŸ“¤ Upload digest artifact
              if: steps.check-images.outputs.build_image == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: digests-${{ matrix.arch }}
                  path: /tmp/digests/${{ matrix.arch }}/digest.txt
                  retention-days: 1

            - name: ğŸ“Š Display cache utilization
              run: |
                  echo "ğŸ“Š Cache Utilization Statistics:"
                  echo "ğŸ—‚ï¸ APT Cache: $(du -sh /tmp/apt-cache 2>/dev/null | cut -f1 || echo '0B')"
                  echo "ğŸ—‚ï¸ APT Lib: $(du -sh /tmp/apt-lib 2>/dev/null | cut -f1 || echo '0B')"
                  echo "ğŸ’¾ Cache Hit: ${{ steps.system-cache.outputs.cache-hit }}"

    ##############################################################################
    # 3) Merge multi-arch manifests
    ##############################################################################
    merge-manifests:
        needs: [prepare, build]
        if: always() && needs.build.result == 'success'
        runs-on: ${{ github.event.inputs.runner || 'ubuntu-latest' }}
        permissions:
            contents: read
            packages: write
        steps:
            - name: ğŸ“¥ Download all digest artifacts
              uses: actions/download-artifact@v4
              with:
                  path: /tmp/digests
                  pattern: digests-*
                  merge-multiple: true

            - name: ğŸ› ï¸ Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: ğŸ”‘ Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ”‘ Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: ğŸ·ï¸ Create multi-arch manifests
              run: |
                  VERSION="${{ needs.prepare.outputs.version_base }}"
                  echo "ğŸ“¦ Creating multi-arch manifests for version $VERSION..."

                  for registry in ghcr dockerhub; do
                    if [ "$registry" = "ghcr" ]; then
                      PREFIX="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
                    else
                      PREFIX="${{ env.DOCKERHUB_REPO }}"
                    fi
                    
                    echo "ğŸ—ï¸ Creating manifests for $PREFIX..."
                    ls -al /tmp/digests
                    # Check which architectures were built
                    ARCH_IMAGES=""
                    for arch in amd64 arm64 armv7; do
                      if [ -f "/tmp/digests/$arch/digest.txt" ]; then
                        ARCH_IMAGES="$ARCH_IMAGES ${PREFIX}:$VERSION-$arch"
                        echo "âœ… Found $arch image"
                      fi
                    done
                    
                    if [ -n "$ARCH_IMAGES" ]; then
                      # Create version-specific manifest
                      docker buildx imagetools create \
                        -t ${PREFIX}:$VERSION \
                        $ARCH_IMAGES
                      echo "âœ… Created version manifest: ${PREFIX}:$VERSION"
                      
                      # Create latest manifest
                      docker buildx imagetools create \
                        -t ${PREFIX}:latest \
                        $ARCH_IMAGES
                      echo "âœ… Created latest manifest: ${PREFIX}:latest"
                    else
                      echo "âŒ No architecture images found for $registry"
                    fi
                  done

    ##############################################################################
    # 4) Build summary
    ##############################################################################
    summary:
        needs: [prepare, build]
        runs-on: ${{ github.event.inputs.runner || 'ubuntu-latest' }}
        steps:
            - name: ğŸ“¥ Download digest artifacts
              uses: actions/download-artifact@v4
              with:
                  path: /tmp/digests
                  pattern: digests-*
                  merge-multiple: true

            - name: ğŸ“Š Generate comprehensive build summary for AdGuard VPN CLI
              run: |
                  # Pre-calculate digest values and status
                  AMD64_DIGEST=$(cat /tmp/digests/amd64/digest.txt 2>/dev/null | cut -c1-12 || echo "N/A")
                  ARM64_DIGEST=$(cat /tmp/digests/arm64/digest.txt 2>/dev/null | cut -c1-12 || echo "N/A")
                  ARMV7_DIGEST=$(cat /tmp/digests/armv7/digest.txt 2>/dev/null | cut -c1-12 || echo "N/A")

                  AMD64_STATUS=$([ -f /tmp/digests/amd64/digest.txt ] && echo "âœ… Success" || echo "âŒ Failed")
                  ARM64_STATUS=$([ -f /tmp/digests/arm64/digest.txt ] && echo "âœ… Success" || echo "âŒ Failed")
                  ARMV7_STATUS=$([ -f /tmp/digests/armv7/digest.txt ] && echo "âœ… Success" || echo "âŒ Failed")

                  BUILD_COUNT=$(ls /tmp/digests 2>/dev/null | wc -l || echo "0")
                  BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')

                  cat >> $GITHUB_STEP_SUMMARY << EOF
                  # ğŸš€ AdGuard VPN CLI Multi-Architecture Build Summary

                  **Build Date**: $BUILD_DATE  
                  **AdGuard VPN CLI Version**: ${{ needs.prepare.outputs.version_base }}  
                  **Release Tag**: ${{ needs.prepare.outputs.version }}  
                  **Build Number**: #${{ github.run_number }}  
                  **Repository**: [${{ github.repository }}](https://github.com/${{ github.repository }})  
                  **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

                  ## ğŸ—ï¸ Multi-Architecture Build Results

                  ### ğŸ“¦ Container Image Digests
                  | Architecture | Digest | Status |
                  |--------------|--------|--------|
                  | **amd64** | \`${AMD64_DIGEST}...\` | ${AMD64_STATUS} |
                  | **arm64** | \`${ARM64_DIGEST}...\` | ${ARM64_STATUS} |
                  | **armv7** | \`${ARMV7_DIGEST}...\` | ${ARMV7_STATUS} |

                  ### ğŸ³ Published Container Registries

                  #### ğŸ¯ Docker Hub (Primary)
                  \`\`\`
                  # Multi-arch latest
                  docker pull ${{ env.DOCKERHUB_REPO }}:latest
                  docker pull ${{ env.DOCKERHUB_REPO }}:${{ needs.prepare.outputs.version_base }}

                  # Architecture-specific
                  docker pull ${{ env.DOCKERHUB_REPO }}:latest-amd64
                  docker pull ${{ env.DOCKERHUB_REPO }}:latest-arm64
                  docker pull ${{ env.DOCKERHUB_REPO }}:latest-armv7
                  \`\`\`

                  #### ğŸ”„ GitHub Container Registry (GHCR)
                  \`\`\`
                  # Multi-arch latest
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version_base }}

                  # Architecture-specific
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-amd64
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-arm64
                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-armv7
                  \`\`\`

                  ## ğŸš€ Quick Start Commands

                  ### Automatic Architecture Detection
                  \`\`\`
                  # Run latest version (auto-detect architecture)
                  docker run -it --rm ${{ env.DOCKERHUB_REPO }}:latest

                  # Check AdGuard VPN CLI version
                  docker run --rm ${{ env.DOCKERHUB_REPO }}:latest adguardvpn-cli --version
                  \`\`\`

                  **ğŸ‰ AdGuard VPN CLI multi-architecture build completed successfully!**  
                  **ğŸ“Š Total Architectures Built**: $BUILD_COUNT  

                  *Generated by [AdGuard VPN CLI Builder](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ Build #${{ github.run_number }}*
                  EOF

    ##############################################################################
    # 5) Create GitHub Release
    ##############################################################################
    create-release:
        needs: [prepare, merge-manifests, summary]
        if: always() && needs.merge-manifests.result == 'success'
        runs-on: ${{ github.event.inputs.runner || 'ubuntu-latest' }}
        permissions:
            contents: write
        steps:
            - name: ğŸ·ï¸ Create comprehensive GitHub Release for AdGuard VPN CLI
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.prepare.outputs.version }}-build-${{ github.run_number }}
                  name: "AdGuard VPN CLI Multi-Arch Release ${{ needs.prepare.outputs.version }} (Build #${{ github.run_number }})"
                  body: |
                      # ğŸš€ AdGuard VPN CLI Multi-Architecture Container Release ${{ needs.prepare.outputs.version }}

                      **Build Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
                      **AdGuard VPN CLI Version**: ${{ needs.prepare.outputs.version_base }}  
                      **Build Workflow**: #${{ github.run_number }}

                      ## ğŸ“¦ Available Container Images (Multi-Arch)

                      ### ğŸ¯ Fast Download (Docker Hub - Recommended)
                      ```
                      # Latest multi-arch release (auto-detect architecture)
                      docker pull ${{ env.DOCKERHUB_REPO }}:latest

                      # Version-specific multi-arch build
                      docker pull ${{ env.DOCKERHUB_REPO }}:${{ needs.prepare.outputs.version_base }}
                      ```

                      ### ğŸ¯ Architecture-Specific Images
                      ```
                      # AMD64 (x86_64) architecture
                      docker pull ${{ env.DOCKERHUB_REPO }}:latest-amd64
                      docker pull ${{ env.DOCKERHUB_REPO }}:${{ needs.prepare.outputs.version_base }}-amd64

                      # ARM64 (aarch64) architecture  
                      docker pull ${{ env.DOCKERHUB_REPO }}:latest-arm64
                      docker pull ${{ env.DOCKERHUB_REPO }}:${{ needs.prepare.outputs.version_base }}-arm64

                      # ARMv7 (32-bit ARM) architecture
                      docker pull ${{ env.DOCKERHUB_REPO }}:latest-armv7
                      docker pull ${{ env.DOCKERHUB_REPO }}:${{ needs.prepare.outputs.version_base }}-armv7
                      ```

                      ## ğŸš€ Quick Start Guide (Multi-Platform)

                      ### Basic AdGuard VPN CLI Usage
                      ```
                      # Run AdGuard VPN CLI (auto-detect architecture)
                      docker run -it --rm ${{ env.DOCKERHUB_REPO }}:latest

                      # Check AdGuard VPN CLI version
                      docker run --rm ${{ env.DOCKERHUB_REPO }}:latest adguardvpn-cli --version

                      # Get help information
                      docker run --rm ${{ env.DOCKERHUB_REPO }}:latest adguardvpn-cli --help
                      ```

                      ### VPN Connection Setup
                      ```
                      # Interactive VPN setup
                      docker run -it --rm \
                        --cap-add NET_ADMIN \
                        --device /dev/net/tun \
                        -e ADGUARD_USERNAME="your_username" \
                        -e ADGUARD_PASSWORD="your_password" \
                        ${{ env.DOCKERHUB_REPO }}:latest

                      # Background VPN with SOCKS5 proxy
                      docker run -d \
                        --name adguard-vpn \
                        --cap-add NET_ADMIN \
                        --device /dev/net/tun \
                        -p 1080:1080 \
                        -e ADGUARD_USERNAME="your_username" \
                        -e ADGUARD_PASSWORD="your_password" \
                        ${{ env.DOCKERHUB_REPO }}:latest
                      ```

                      ---

                      **ğŸš€ Ready for universal AdGuard VPN protection?**  
                      **Start with**: `docker run -it --rm ${{ env.DOCKERHUB_REPO }}:latest`

                      **â­ Love the multi-arch support?** Star the repository and share!
                  files: /tmp/digests/*/digest.txt
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
